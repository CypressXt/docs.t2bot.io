<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Thumbnails - matrix-media-repo</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Information for matrix-media-repo">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../intro.html">Introduction</a></li><li class="chapter-item expanded "><a href="../installing/index.html"><strong aria-hidden="true">1.</strong> Installation and requirements</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../installing/environments.html"><strong aria-hidden="true">1.1.</strong> Intended environments</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../installing/environments/medium-large.html"><strong aria-hidden="true">1.1.1.</strong> Medium/large servers</a></li><li class="chapter-item expanded "><a href="../installing/environments/multiple-servers.html"><strong aria-hidden="true">1.1.2.</strong> Multiple servers</a></li><li class="chapter-item expanded "><a href="../installing/environments/hosting.html"><strong aria-hidden="true">1.1.3.</strong> Hosting providers</a></li></ol></li><li class="chapter-item expanded "><a href="../installing/methods.html"><strong aria-hidden="true">1.2.</strong> Installation methods</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../installing/method/docker.html"><strong aria-hidden="true">1.2.1.</strong> Docker</a></li><li class="chapter-item expanded "><a href="../installing/method/download.html"><strong aria-hidden="true">1.2.2.</strong> Downloads</a></li><li class="chapter-item expanded "><a href="../installing/method/compilation.html"><strong aria-hidden="true">1.2.3.</strong> Compilation</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../deployment/index.html"><strong aria-hidden="true">2.</strong> Deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../deployment/nginx.html"><strong aria-hidden="true">2.1.</strong> Example: nginx</a></li><li class="chapter-item expanded "><a href="../deployment/horizontal_scaling.html"><strong aria-hidden="true">2.2.</strong> Horizontal scaling</a></li></ol></li><li class="chapter-item expanded "><a href="../upgrading/index.html"><strong aria-hidden="true">3.</strong> Upgrading</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../upgrading/130.html"><strong aria-hidden="true">3.1.</strong> Upgrading to v1.3.0</a></li></ol></li><li class="chapter-item expanded "><a href="../configuration/index.html"><strong aria-hidden="true">4.</strong> Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../configuration/datastores.html"><strong aria-hidden="true">4.1.</strong> Datastores</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../configuration/file-datastore.html"><strong aria-hidden="true">4.1.1.</strong> File-based</a></li><li class="chapter-item expanded "><a href="../configuration/s3-datastore.html"><strong aria-hidden="true">4.1.2.</strong> S3</a></li></ol></li><li class="chapter-item expanded "><a href="../configuration/per-domain.html"><strong aria-hidden="true">4.2.</strong> Split configs/per-domain</a></li><li class="chapter-item expanded "><a href="../configuration/memory.html"><strong aria-hidden="true">4.3.</strong> Calculating memory requirements</a></li><li class="chapter-item expanded "><a href="../configuration/storage.html"><strong aria-hidden="true">4.4.</strong> Calculating storage requirements</a></li><li class="chapter-item expanded "><a href="../configuration/general.html"><strong aria-hidden="true">4.5.</strong> General configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../configuration/logging.html"><strong aria-hidden="true">4.5.1.</strong> Logging</a></li><li class="chapter-item expanded "><a href="../configuration/forwarded-addresses.html"><strong aria-hidden="true">4.5.2.</strong> Forwarded addresses</a></li><li class="chapter-item expanded "><a href="../configuration/federation.html"><strong aria-hidden="true">4.5.3.</strong> Federation</a></li><li class="chapter-item expanded "><a href="../configuration/database-pool.html"><strong aria-hidden="true">4.5.4.</strong> Database pool</a></li><li class="chapter-item expanded "><a href="../configuration/timeouts.html"><strong aria-hidden="true">4.5.5.</strong> Timeouts</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../uploads/index.html"><strong aria-hidden="true">5.</strong> Uploads</a></li><li class="chapter-item expanded "><a href="../downloads/index.html"><strong aria-hidden="true">6.</strong> Downloads (remote media)</a></li><li class="chapter-item expanded "><a href="../thumbnails/index.html" class="active"><strong aria-hidden="true">7.</strong> Thumbnails</a></li><li class="chapter-item expanded "><a href="../identicons/index.html"><strong aria-hidden="true">8.</strong> Identicons</a></li><li class="chapter-item expanded "><a href="../url-previews/index.html"><strong aria-hidden="true">9.</strong> URL previews</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../url-previews/security.html"><strong aria-hidden="true">9.1.</strong> Security</a></li><li class="chapter-item expanded "><a href="../url-previews/oembed.html"><strong aria-hidden="true">9.2.</strong> oEmbed</a></li></ol></li><li class="chapter-item expanded "><a href="../cache/index.html"><strong aria-hidden="true">10.</strong> Cache</a></li><li class="chapter-item expanded "><a href="../metrics/index.html"><strong aria-hidden="true">11.</strong> Metrics</a></li><li class="chapter-item expanded "><a href="../shared-secret/index.html"><strong aria-hidden="true">12.</strong> Shared secret authentication</a></li><li class="chapter-item expanded "><a href="../access-token-cache/index.html"><strong aria-hidden="true">13.</strong> Access token cache</a></li><li class="chapter-item expanded "><a href="../archival/index.html"><strong aria-hidden="true">14.</strong> Imports, exports, and archiving</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../archival/exports.html"><strong aria-hidden="true">14.1.</strong> Exports</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../archival/gdpr.html"><strong aria-hidden="true">14.1.1.</strong> GDPR</a></li></ol></li><li class="chapter-item expanded "><a href="../archival/imports.html"><strong aria-hidden="true">14.2.</strong> Imports</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../archival/import-from-synapse.html"><strong aria-hidden="true">14.2.1.</strong> From Synapse</a></li><li class="chapter-item expanded "><a href="../archival/import-from-export.html"><strong aria-hidden="true">14.2.2.</strong> From Export</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../quotas/index.html"><strong aria-hidden="true">15.</strong> Quotas</a></li><li class="chapter-item expanded "><a href="../rate-limit/index.html"><strong aria-hidden="true">16.</strong> Rate limiting</a></li><li class="chapter-item expanded "><a href="../quarantine/index.html"><strong aria-hidden="true">17.</strong> Quarantine / abuse mitigation</a></li><li class="chapter-item expanded "><a href="../blurhash/index.html"><strong aria-hidden="true">18.</strong> MSC2448: Blurhash</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">matrix-media-repo</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/t2bot/docs.t2bot.io/tree/master/matrix-media-repo" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="thumbnails"><a class="header" href="#thumbnails">Thumbnails</a></h1>
<p>Thumbnails are requested by most clients to ensure that things like images can be shown at a smaller
size than the full media. Thumbnails have a large memory and CPU requirement and are the most
requested resource of the media repo.</p>
<p>The full configuration for thumbnails is:</p>
<pre><code class="language-yaml">thumbnails:
  maxSourceBytes: 10485760 # 10MB default, 0 to disable
  numWorkers: 100
  expireAfterDays: 0
  sizes:
    - width: 32
      height: 32
    - width: 96
      height: 96
    - width: 320
      height: 240
    - width: 640
      height: 480
    - width: 800
      height: 600
  dynamicSizing: false
  allowAnimated: true
  defaultAnimated: false
  maxAnimateSizeBytes: 10485760 # 10MB default, 0 to disable
  stillFrame: 0.5
  types:
    - &quot;image/jpeg&quot;
    - &quot;image/jpg&quot;
    - &quot;image/png&quot;
    - &quot;image/gif&quot;
    - &quot;image/heif&quot;
    - &quot;image/webp&quot;
    #- &quot;image/jxl&quot; # Be sure to have ImageMagick installed to thumbnail JPEG XL files
    #- &quot;image/svg+xml&quot; # Be sure to have ImageMagick installed to thumbnail SVG files
</code></pre>
<p>Many of these options are described in later sections.</p>
<p><code>maxSourceBytes</code> controls how big of media is allowed to be thumbnailed. Typically the memory
usage for a thumbnail will be at worse 1.5x this value, multipled by <code>numWorkers</code> (the number of
thumbnails to generate concurrently). To avoid exhausting the server of memory, it is recommended to
keep this at roughly 1/10th the maximum upload size, though specific use cases may call for less or
more.</p>
<p><code>numWorkers</code>, as mentioned, is the number of concurrent thumbnails to process. The media repo will
queue up thumbnails which need to be generated, though with thumbnails being the most highly requested
resource it is important to ensure there is enough room to process those thumbnails. Once a thumbnail
is generated, it is stored in the media repo so it does not need to be re-generated again.</p>
<p>Approximately 2 weeks after a thumbnail has been generated, clients are unlikely to request a
thumbnail again. To save space, <code>expireAfterDays</code> can be set to clean up thumbnails which have been
previously generated. If a client re-requests a thumbnail, it will be regenerated.</p>
<h2 id="thumbnail-sizes--dynamic-sizing"><a class="header" href="#thumbnail-sizes--dynamic-sizing">Thumbnail sizes &amp; dynamic sizing</a></h2>
<p>The <code>sizes</code> control which buckets to fit thumbnails into. The Matrix specification allows the media
repo to return a <em>larger</em> thumbnail than the client requested, or a maximum size if no larger size
is available. As such, the media repo will return a thumbnail exactly matching one of these sizes
depending on the request from the client. The most common size requests are shown above.</p>
<p>For more pixel-perfect thumbnails that aren't potentially blurry in clients, set <code>dynamicSizing: true</code>
to ignore the <code>sizes</code> list and instead generate a thumbnail for the exact size the client requested.
This will lead to significantly more thumbnails being generated, which means higher storage
requirements and higher resource requirements (typically).</p>
<h2 id="animated-thumbnails"><a class="header" href="#animated-thumbnails">Animated thumbnails</a></h2>
<p>Thumbnails by default are static images which are resized and cropped to the appropriate dimensions.
Some image formats, like GIFs, can sometimes be better as animated thumbnails instead of a static
image.</p>
<p>For non-animated thumbnails on animated file types (like GIFs), the <code>stillFrame</code> option chooses where
in the file's duration to generate a thumbnail from. By default this is <code>0.5</code> to use an image from the
middle in order to handle GIFs which would appear as a transparent frame if picked from the start.</p>
<p>Animated thumbnails can be entirely turned off using <code>allowAnimated</code>, forcing the media repo to use
the <code>stillFrame</code> option for all animated media types.</p>
<p>Animated thumbnails can be requested by clients, though many do not support this custom flag on the
media repo. To change the behaviour to turn on animations by default, set <code>defaultAnimated: true</code>.</p>
<p>Animated thumbnails can be much more resource intensive to handle than regular thumbnails, and as
such the source material can be limited with <code>maxAnimateSizeBytes</code>. This option only applies when
the media repo is generating an animated thumbnail. It is recommended to keep this value fairly
small to avoid letting resource usage exceed expectations.</p>
<h2 id="thumbnail-types"><a class="header" href="#thumbnail-types">Thumbnail types</a></h2>
<p>The <code>types</code> controls which mimetypes of media the media repo should try to thumbnail. The media
repo supports the mimetypes listed in the sample config, with more being possible in the future.</p>
<p><strong>Note</strong>: <code>image/svg+xml</code> requires <a href="https://imagemagick.org/index.php">ImageMagick</a> to be available
to the media repo. The Docker image contains the appropriate binaries for this to happen.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../downloads/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../identicons/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../downloads/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../identicons/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
