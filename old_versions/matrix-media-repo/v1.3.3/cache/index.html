<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Cache - matrix-media-repo</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Information for matrix-media-repo">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../intro.html">Introduction</a></li><li class="chapter-item expanded "><a href="../installing/index.html"><strong aria-hidden="true">1.</strong> Installation and requirements</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../installing/environments.html"><strong aria-hidden="true">1.1.</strong> Intended environments</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../installing/environments/medium-large.html"><strong aria-hidden="true">1.1.1.</strong> Medium/large servers</a></li><li class="chapter-item expanded "><a href="../installing/environments/multiple-servers.html"><strong aria-hidden="true">1.1.2.</strong> Multiple servers</a></li><li class="chapter-item expanded "><a href="../installing/environments/hosting.html"><strong aria-hidden="true">1.1.3.</strong> Hosting providers</a></li></ol></li><li class="chapter-item expanded "><a href="../installing/methods.html"><strong aria-hidden="true">1.2.</strong> Installation methods</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../installing/method/docker.html"><strong aria-hidden="true">1.2.1.</strong> Docker</a></li><li class="chapter-item expanded "><a href="../installing/method/download.html"><strong aria-hidden="true">1.2.2.</strong> Downloads</a></li><li class="chapter-item expanded "><a href="../installing/method/compilation.html"><strong aria-hidden="true">1.2.3.</strong> Compilation</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../deployment/index.html"><strong aria-hidden="true">2.</strong> Deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../deployment/nginx.html"><strong aria-hidden="true">2.1.</strong> Example: nginx</a></li><li class="chapter-item expanded "><a href="../deployment/horizontal_scaling.html"><strong aria-hidden="true">2.2.</strong> Horizontal scaling</a></li></ol></li><li class="chapter-item expanded "><a href="../upgrading/index.html"><strong aria-hidden="true">3.</strong> Upgrading</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../upgrading/130.html"><strong aria-hidden="true">3.1.</strong> Upgrading to v1.3.0</a></li></ol></li><li class="chapter-item expanded "><a href="../configuration/index.html"><strong aria-hidden="true">4.</strong> Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../configuration/datastores.html"><strong aria-hidden="true">4.1.</strong> Datastores</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../configuration/file-datastore.html"><strong aria-hidden="true">4.1.1.</strong> File-based</a></li><li class="chapter-item expanded "><a href="../configuration/s3-datastore.html"><strong aria-hidden="true">4.1.2.</strong> S3</a></li></ol></li><li class="chapter-item expanded "><a href="../configuration/per-domain.html"><strong aria-hidden="true">4.2.</strong> Split configs/per-domain</a></li><li class="chapter-item expanded "><a href="../configuration/memory.html"><strong aria-hidden="true">4.3.</strong> Calculating memory requirements</a></li><li class="chapter-item expanded "><a href="../configuration/storage.html"><strong aria-hidden="true">4.4.</strong> Calculating storage requirements</a></li><li class="chapter-item expanded "><a href="../configuration/general.html"><strong aria-hidden="true">4.5.</strong> General configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../configuration/logging.html"><strong aria-hidden="true">4.5.1.</strong> Logging</a></li><li class="chapter-item expanded "><a href="../configuration/forwarded-addresses.html"><strong aria-hidden="true">4.5.2.</strong> Forwarded addresses</a></li><li class="chapter-item expanded "><a href="../configuration/federation.html"><strong aria-hidden="true">4.5.3.</strong> Federation</a></li><li class="chapter-item expanded "><a href="../configuration/database-pool.html"><strong aria-hidden="true">4.5.4.</strong> Database pool</a></li><li class="chapter-item expanded "><a href="../configuration/timeouts.html"><strong aria-hidden="true">4.5.5.</strong> Timeouts</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../uploads/index.html"><strong aria-hidden="true">5.</strong> Uploads</a></li><li class="chapter-item expanded "><a href="../downloads/index.html"><strong aria-hidden="true">6.</strong> Downloads (remote media)</a></li><li class="chapter-item expanded "><a href="../thumbnails/index.html"><strong aria-hidden="true">7.</strong> Thumbnails</a></li><li class="chapter-item expanded "><a href="../identicons/index.html"><strong aria-hidden="true">8.</strong> Identicons</a></li><li class="chapter-item expanded "><a href="../url-previews/index.html"><strong aria-hidden="true">9.</strong> URL previews</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../url-previews/security.html"><strong aria-hidden="true">9.1.</strong> Security</a></li><li class="chapter-item expanded "><a href="../url-previews/oembed.html"><strong aria-hidden="true">9.2.</strong> oEmbed</a></li></ol></li><li class="chapter-item expanded "><a href="../cache/index.html" class="active"><strong aria-hidden="true">10.</strong> Cache</a></li><li class="chapter-item expanded "><a href="../metrics/index.html"><strong aria-hidden="true">11.</strong> Metrics</a></li><li class="chapter-item expanded "><a href="../shared-secret/index.html"><strong aria-hidden="true">12.</strong> Shared secret authentication</a></li><li class="chapter-item expanded "><a href="../access-token-cache/index.html"><strong aria-hidden="true">13.</strong> Access token cache</a></li><li class="chapter-item expanded "><a href="../archival/index.html"><strong aria-hidden="true">14.</strong> Imports, exports, and archiving</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../archival/exports.html"><strong aria-hidden="true">14.1.</strong> Exports</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../archival/gdpr.html"><strong aria-hidden="true">14.1.1.</strong> GDPR</a></li></ol></li><li class="chapter-item expanded "><a href="../archival/imports.html"><strong aria-hidden="true">14.2.</strong> Imports</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../archival/import-from-synapse.html"><strong aria-hidden="true">14.2.1.</strong> From Synapse</a></li><li class="chapter-item expanded "><a href="../archival/import-from-export.html"><strong aria-hidden="true">14.2.2.</strong> From Export</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../quotas/index.html"><strong aria-hidden="true">15.</strong> Quotas</a></li><li class="chapter-item expanded "><a href="../rate-limit/index.html"><strong aria-hidden="true">16.</strong> Rate limiting</a></li><li class="chapter-item expanded "><a href="../quarantine/index.html"><strong aria-hidden="true">17.</strong> Quarantine / abuse mitigation</a></li><li class="chapter-item expanded "><a href="../blurhash/index.html"><strong aria-hidden="true">18.</strong> MSC2448: Blurhash</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">matrix-media-repo</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/t2bot/docs.t2bot.io/tree/main/matrix-media-repo" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="cache"><a class="header" href="#cache">Cache</a></h1>
<p>The media repo caches media for faster access on frequently requested media. Only one cache mechanism
can be used at a time.</p>
<h2 id="redis"><a class="header" href="#redis">Redis</a></h2>
<p>Redis can be used as a high-performance cache for the media repo, allowing for (in future) multiple
media repositories to run concurrently in limited jobs (such as some processes handling uploads,
others downloads, etc). Currently though, it is capable of speeding up deployments of disjointed
media repos or in preparation for proper load balancer support by the media repo.</p>
<p>The media repo connects to a number of &quot;shards&quot; (Redis processes) to distribute cached keys over
them. Each shard is not expected to store persistent data and should be tolerant of total failure -
the media repo assumes that the shards will be dedicated to caching and thus will not have any
expectations that a particular shard will remain running.</p>
<p>Setting up a shard is fairly simple: it's the same as deploying Redis itself. The media repo does not
manage the expiration policy for the shards, so it is recommended to give
<a href="https://redis.io/topics/lru-cache">the Redis docs</a> a read to pick the best eviction policy for your
environment. The current recommendations are:</p>
<ul>
<li>A <code>maxmemory</code> of at least <code>1gb</code> for each shard.</li>
<li>A <code>maxmemory-policy</code> of <code>allkeys-lfu</code> to ensure that the cache gets cleared out (the media repo
does not set an expiration time or TTL). Note: an <code>lru</code> mode is <em>not</em> recommended as the media repo
will be caching all uploads it sees, which includes remote media. A <code>lfu</code> mode ensures that recent
items being cached can still be evicted if not commonly requested.</li>
<li>1 shard for most deployments. Larger repos (or connecting many media repos to the same shards)
should consider 3 or more shards.</li>
</ul>
<p>The shards in the ring can be changed at runtime by updating the config and ensuring the media repo
has reloaded the config. Note that changing cache mechanisms at runtime is not recommended, and a
full restart is recommended instead.</p>
<p><strong>Note</strong>: Metrics reported for cache size will be inaccurate. Frequencies of requests will still be
reported.</p>
<p><strong>Note</strong>: Quarantined media will still be stored in the cache. This is considered a bug and will need
fixing.</p>
<h2 id="connecting-multiple-disjointed-media-repos-hosting-providers"><a class="header" href="#connecting-multiple-disjointed-media-repos-hosting-providers">Connecting multiple disjointed media repos (hosting providers)</a></h2>
<p>Though the media repo expects to be the sole and only thing in the datacenter handling media, it is
not always possible or sane to do so. Examples including hosting providers which may have several
media repos handling a small subset of domains each. In these scenarios, it may be beneficial to set
up a series of Redis shards within each datacenter and connect all the media repos in that DC to
them. This can reduce the amount of time it takes to retrieve media from a media repo in that DC, as
well as avoid downloading several copies of remote media.</p>
<p>Note that even when connecting media repos to the same set of shards the repos will still attempt to
upload a copy of the media to the datastore. For example, if media repo A downloads something from
matrix.org and puts it into the cache, media repo B will first get it from the cache and upload it to
its datastore when a user  requests the same media. The benefit, however, is that only 1 request to
matrix.org happened instead of two.</p>
<p>All media repos should be connected to the same set of shards to ensure even balancing between the
shards. Additionally, all media repos <strong>must</strong> be running the same major version (anything in
<code>1.x.x</code>) in order to avoid conflicts.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../url-previews/oembed.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../metrics/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../url-previews/oembed.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../metrics/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
